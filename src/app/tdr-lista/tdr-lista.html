<div class="page-container fade-in">
    <div class="header-flex">
        <div>
            <h2 class="titulo-principal"><i class="fas fa-file-alt me-2"></i>Gesti√≥n de TDRs</h2>
            <p class="text-muted">T√©rminos de Referencia y Procesos de Contrataci√≥n</p>
        </div>
        
        <button class="btn-crear" (click)="abrirModalNuevo()">
            <i class="fas fa-plus me-2"></i>Nuevo TDR
        </button>
    </div>

    <div class="card-tabla">
        <div *ngIf="cargando" class="text-center p-5">
            <p>‚è≥ Cargando datos...</p>
        </div>

        <div *ngIf="!cargando && tdrs.length > 0" class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>C√ìDIGO</th>
                        <th>OBJETO CONTRATACI√ìN</th>
                        <th>PRESUPUESTO</th>
                        <th>ESTADO</th>
                        <th style="min-width: 150px;">ACCIONES</th> 
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of tdrs">
                        <td class="fw-bold text-primary">{{ item.numero_tdr || item.codigo }}</td>
                        <td>{{ item.objeto_contratacion }}</td>
                        <td class="fw-bold text-success">
                            ${{ (item.presupuesto_referencial || item.presupuesto || 0) | number:'1.2-2' }}
                        </td>
                        <td>
                            <span class="badge" [ngClass]="getClaseBadge(item.estado || item.nombre_estado)">
                                {{ getTextoEstado(item.estado || item.nombre_estado) }}
                            </span>
                        </td>
                        <td class="acciones-cell">
                            <div style="display: flex; gap: 8px;">
                                <button (click)="verTdr(item)" title="Ver y Subir Archivos" style="background: #003366; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                    üîç
                                </button>
                                
                                <button *ngIf="esAdmin" (click)="editarTdr(item)" title="Editar TDR" style="background: #ffc107; color: black; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                    ‚úèÔ∏è
                                </button>
                                <button *ngIf="esAdmin" (click)="eliminarTdr(item)" title="Eliminar TDR" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div *ngIf="!cargando && tdrs.length === 0" class="text-center p-5 text-muted">
            <h5>No hay TDRs registrados</h5>
        </div>
    </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
    <div class="modal-content" (click)="$event.stopPropagation()" style="background: white; width: 95%; max-width: 800px; padding: 0; border-radius: 12px; display: flex; flex-direction: column; max-height: 90vh;">
        
        <div style="background: #003366; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 18px;">
                {{ esEdicion ? '‚úèÔ∏è Editar TDR' : 'üìù Registrar Nuevo TDR' }}
            </h3>
            <button (click)="cerrarModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
        </div>

        <div style="padding: 25px; overflow-y: auto;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label style="font-weight: bold; font-size: 12px; color: #555;">N√öMERO DE TDR:</label>
                    <input type="text" [(ngModel)]="nuevoTdr.numero_tdr" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 12px; color: #555;">TIPO PROCESO:</label>
                    <select [(ngModel)]="nuevoTdr.tipo_proceso" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option>√çnfima Cuant√≠a</option>
                        <option>Cat√°logo Electr√≥nico</option>
                        <option>R√©gimen Especial</option>
                        <option>Subasta Inversa</option>
                        <option>Consultor√≠a</option>
                    </select>
                </div>

                <div style="grid-column: span 2;">
                    <label style="font-weight: bold; font-size: 12px; color: #555;">OBJETO DE CONTRATACI√ìN:</label>
                    <textarea [(ngModel)]="nuevoTdr.objeto_contratacion" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                </div>

                <div>
                    <label style="font-weight: bold; font-size: 12px; color: #555;">DIRECCI√ìN SOLICITANTE:</label>
                    <select [(ngModel)]="nuevoTdr.direccion_solicitante" (change)="verificarDireccion()" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="" disabled selected>-- Seleccione --</option>
                        <option value="TICs (Tecnolog√≠a)">TICs (Tecnolog√≠a)</option>
                        <option value="Administrativa Financiera">Administrativa Financiera</option>
                        <option value="Direcci√≥n Ejecutiva">Direcci√≥n Ejecutiva</option>
                        <option value="Meteorolog√≠a">Meteorolog√≠a</option>
                        <option value="Hidrolog√≠a">Hidrolog√≠a</option>
                        <option value="Otras">üìç Otras...</option>
                    </select>
                    <input *ngIf="mostrarOtraDireccion" type="text" [(ngModel)]="otraDireccionTexto" placeholder="Especifique direcci√≥n..." style="width: 100%; margin-top: 5px; padding: 8px; border: 1px solid #007bff; border-radius: 4px;">
                </div>

                <div>
                    <label style="font-weight: bold; font-size: 12px; color: #555;">PRESUPUESTO ($):</label>
                    <input type="number" [(ngModel)]="nuevoTdr.presupuesto" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>

                <div>
                    <label style="font-weight: bold; font-size: 12px; color: #555;">RESPONSABLE:</label>
                    <input type="text" [(ngModel)]="nuevoTdr.responsable_designado" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 12px; color: #555;">PER√çODO CONTRATO:</label>
                    <input type="text" [(ngModel)]="nuevoTdr.periodo_contrato" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>

                <div>
                    <label style="font-weight: bold; font-size: 12px; color: #555;">FECHA INICIO:</label>
                    <input type="date" [(ngModel)]="nuevoTdr.fecha_inicio" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 12px; color: #dc3545;">FECHA FIN (VENCIMIENTO):</label>
                    <input type="date" [(ngModel)]="nuevoTdr.fecha_fin" style="width: 100%; padding: 8px; border: 1px solid #dc3545; border-radius: 4px;">
                </div>
            </div>
        </div>

        <div style="background: #eee; padding: 15px; text-align: right; border-top: 1px solid #ddd;">
            <button (click)="cerrarModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Cancelar</button>
            <button (click)="guardarTdr()" style="background: #003366; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                {{ esEdicion ? 'üíæ Actualizar Cambios' : 'üíæ Guardar TDR' }}
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalVer && tdrSeleccionado" (click)="cerrarModalVer()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
    <div class="modal-content" (click)="$event.stopPropagation()" style="background: white; width: 95%; max-width: 800px; padding: 0; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh;">
        
        <div style="background: #003366; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin: 0; font-size: 18px;">üìÑ Ficha T√©cnica del TDR</h3>
                <span style="font-size: 12px; opacity: 0.8;">{{ tdrSeleccionado.numero_tdr }}</span>
            </div>
            <button (click)="cerrarModalVer()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">√ó</button>
        </div>

        <div style="padding: 25px; overflow-y: auto;">
            
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 25px;">
                <h4 style="margin-top: 0; color: #003366; font-size: 14px; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 15px;">
                    üìå Informaci√≥n del Proceso
                </h4>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <div style="grid-column: span 2;">
                        <label style="font-size: 11px; font-weight: bold; color: #666;">OBJETO DE CONTRATACI√ìN</label>
                        <p style="margin: 5px 0; font-size: 14px;">{{ tdrSeleccionado.objeto_contratacion }}</p>
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: bold; color: #666;">PRESUPUESTO</label>
                        <p style="margin: 5px 0; font-weight: bold; color: #28a745;">${{ (tdrSeleccionado.presupuesto_referencial || 0) | number:'1.2-2' }}</p>
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: bold; color: #666;">DIRECCI√ìN</label>
                        <p style="margin: 5px 0;">{{ tdrSeleccionado.direccion_solicitante || 'No especificada' }}</p>
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: bold; color: #666;">ESTADO</label>
                        <span class="badge" [ngClass]="getClaseBadge(tdrSeleccionado.estado)" style="margin-top: 5px; display: inline-block;">
                            {{ getTextoEstado(tdrSeleccionado.estado) }}
                        </span>
                    </div>
                </div>
            </div>

            <h4 style="margin-top: 0; color: #003366; font-size: 14px; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 15px;">
                üìÅ Expediente Digital
            </h4>

            <div class="docs-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center;">
                    <p style="font-weight: bold; margin-bottom: 10px;">Informe Necesidad</p>

                    <div *ngIf="tdrSeleccionado.nombre_archivo_necesidad" class="archivo-cargado">
                        <i class="fas fa-file-pdf text-danger" style="font-size: 30px; margin-bottom: 5px;"></i>
                        <br>
                        <small style="display:block; margin-bottom:10px; word-break: break-all; font-weight: bold;">
                            {{ tdrSeleccionado.nombre_archivo_necesidad }}
                        </small>
                        
                        <button (click)="descargarArchivo(tdrSeleccionado.ruta_necesidad)" class="btn btn-info btn-sm" style="margin-right: 5px;" title="Ver PDF">
                            üëÅÔ∏è
                        </button>
                        
                        <button *ngIf="esAdmin" (click)="eliminarArchivo(tdrSeleccionado.id_archivo_necesidad)" class="btn btn-danger btn-sm" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </div>

                    <div *ngIf="!tdrSeleccionado.nombre_archivo_necesidad">
                        <button (click)="triggerUpload('necesidad')" class="btn btn-primary btn-sm" style="background: #003366; color: white; border: none; padding: 6px 15px; border-radius: 4px;">
                            ‚¨ÜÔ∏è Subir PDF
                        </button>
                    </div>
                    <input type="file" id="file-necesidad" style="display: none;" accept="application/pdf" (change)="onFileSelected($event, 'necesidad')">
                </div>

                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center;">
                    <p style="font-weight: bold; margin-bottom: 10px;">Documento TDR</p>

                    <div *ngIf="tdrSeleccionado.nombre_archivo_tdr" class="archivo-cargado">
                        <i class="fas fa-file-contract text-primary" style="font-size: 30px; margin-bottom: 5px;"></i>
                        <br>
                        <small style="display:block; margin-bottom:10px; word-break: break-all; font-weight: bold;">
                            {{ tdrSeleccionado.nombre_archivo_tdr }}
                        </small>
                        
                        <button (click)="descargarArchivo(tdrSeleccionado.ruta_tdr)" class="btn btn-info btn-sm" style="margin-right: 5px;" title="Ver PDF">
                            üëÅÔ∏è
                        </button>
                        
                        <button *ngIf="esAdmin" (click)="eliminarArchivo(tdrSeleccionado.id_archivo_tdr)" class="btn btn-danger btn-sm" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </div>

                    <div *ngIf="!tdrSeleccionado.nombre_archivo_tdr">
                        <button (click)="triggerUpload('tdr')" class="btn btn-primary btn-sm" style="background: #003366; color: white; border: none; padding: 6px 15px; border-radius: 4px;">
                            ‚¨ÜÔ∏è Subir PDF
                        </button>
                    </div>
                    <input type="file" id="file-tdr" style="display: none;" accept="application/pdf" (change)="onFileSelected($event, 'tdr')">
                </div>
            </div>

        <div style="background: #eee; padding: 15px; text-align: right;">
            <button (click)="cerrarModalVer()" style="background: #555; color: white; border: none; padding: 8px 25px; border-radius: 4px; cursor: pointer;">Cerrar</button>
        </div>
    </div>
</div>