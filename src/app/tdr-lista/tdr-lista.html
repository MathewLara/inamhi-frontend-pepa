<div class="page-container fade-in">
    <div class="header-flex">
        <div>
            <h2 class="titulo-principal"><i class="fas fa-file-alt me-2"></i>Gesti√≥n de TDRs</h2>
            <p class="text-muted">T√©rminos de Referencia y Procesos de Contrataci√≥n</p>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button (click)="exportarReporteGeneral()" style="background-color: #dc3545; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                üìÑ Exportar Reporte
            </button>

            <button class="btn-crear" (click)="abrirModalNuevo()">
                <i class="fas fa-plus me-2"></i>Nuevo TDR
            </button>
        </div>
    </div>

    <div class="card-tabla">
        <div *ngIf="cargando" class="text-center p-5">
            <p>‚è≥ Cargando datos...</p>
        </div>

        <div *ngIf="!cargando && tdrs.length > 0" class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>C√ìDIGO</th>
                        <th>OBJETO CONTRATACI√ìN</th>
                        <th>PRESUPUESTO</th>
                        <th>ESTADO</th>
                        <th style="min-width: 150px;">ACCIONES</th> 
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of tdrs">
                        <td class="fw-bold text-primary">{{ item.numero_tdr || item.codigo }}</td>
                        <td>{{ item.objeto_contratacion }}</td>
                        <td class="fw-bold text-success">
                            ${{ (item.presupuesto_referencial || item.presupuesto || 0) | number:'1.2-2' }}
                        </td>
                        <td>
                            <span class="badge" [ngClass]="getClaseBadge(item.estado || item.nombre_estado)">
                                {{ getTextoEstado(item.estado || item.nombre_estado) }}
                            </span>
                        </td>
                        <td class="acciones-cell">
                            <div style="display: flex; gap: 8px;">
                                <button (click)="verTdr(item)" title="Ver y Subir Archivos" class="btn-ver">
                                    üîç
                                </button>
                                
                                <button *ngIf="esAdmin" (click)="editarTdr(item)" title="Editar TDR" style="background: #ffc107; color: black; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                                    ‚úèÔ∏è
                                </button>
                                <button *ngIf="esAdmin" (click)="eliminarTdr(item)" title="Eliminar TDR" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div *ngIf="!cargando && tdrs.length === 0" class="text-center p-5 text-muted">
            <h5>No hay TDRs registrados</h5>
        </div>
    </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
    <div class="modal-content" (click)="$event.stopPropagation()" style="width: 95%; max-width: 800px;">
        
        <div class="modal-header">
            <h3>{{ esEdicion ? '‚úèÔ∏è Editar TDR' : 'üìù Registrar Nuevo TDR' }}</h3>
            <button class="btn-close-x" (click)="cerrarModal()">√ó</button>
        </div>

        <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>N√öMERO DE TDR:</label>
                    <input type="text" [(ngModel)]="nuevoTdr.numero_tdr" class="input-custom">
                </div>
                <div class="form-group">
                    <label>TIPO PROCESO:</label>
                    <select [(ngModel)]="nuevoTdr.tipo_proceso" class="input-custom">
                        <option>√çnfima Cuant√≠a</option>
                        <option>Cat√°logo Electr√≥nico</option>
                        <option>R√©gimen Especial</option>
                        <option>Subasta Inversa</option>
                        <option>Consultor√≠a</option>
                    </select>
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label>OBJETO DE CONTRATACI√ìN:</label>
                    <textarea [(ngModel)]="nuevoTdr.objeto_contratacion" rows="2" class="input-custom"></textarea>
                </div>

                <div class="form-group">
                    <label>DIRECCI√ìN SOLICITANTE:</label>
                    <select [(ngModel)]="nuevoTdr.direccion_solicitante" (change)="verificarDireccion()" class="input-custom">
                        <option value="" disabled selected>-- Seleccione --</option>
                        <option value="TICs (Tecnolog√≠a)">TICs (Tecnolog√≠a)</option>
                        <option value="Administrativa Financiera">Administrativa Financiera</option>
                        <option value="Direcci√≥n Ejecutiva">Direcci√≥n Ejecutiva</option>
                        <option value="Meteorolog√≠a">Meteorolog√≠a</option>
                        <option value="Hidrolog√≠a">Hidrolog√≠a</option>
                        <option value="Otras">üìç Otras...</option>
                    </select>
                    <input *ngIf="mostrarOtraDireccion" type="text" [(ngModel)]="otraDireccionTexto" placeholder="Especifique direcci√≥n..." class="input-custom" style="margin-top: 5px;">
                </div>

                <div class="form-group">
                    <label>PRESUPUESTO ($):</label>
                    <input type="number" [(ngModel)]="nuevoTdr.presupuesto" class="input-custom">
                </div>

                <div class="form-group">
                    <label>RESPONSABLE:</label>
                    <input type="text" [(ngModel)]="nuevoTdr.responsable_designado" class="input-custom">
                </div>
                <div class="form-group">
                    <label>PER√çODO CONTRATO:</label>
                    <input type="text" [(ngModel)]="nuevoTdr.periodo_contrato" class="input-custom">
                </div>

                <div class="form-group">
                    <label>FECHA INICIO:</label>
                    <input type="date" [(ngModel)]="nuevoTdr.fecha_inicio" class="input-custom">
                </div>
                <div class="form-group">
                    <label style="color: #dc3545;">FECHA FIN (VENCIMIENTO):</label>
                    <input type="date" [(ngModel)]="nuevoTdr.fecha_fin" class="input-custom" style="border-color: #dc3545;">
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button (click)="cerrarModal()" class="btn-cancelar">Cancelar</button>
            <button (click)="guardarTdr()" class="btn-guardar">
                {{ esEdicion ? 'üíæ Actualizar Cambios' : 'üíæ Guardar TDR' }}
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalVer && tdrSeleccionado" (click)="cerrarModalVer()">
    <div class="modal-content" (click)="$event.stopPropagation()" style="width: 95%; max-width: 800px;">
        
        <div class="modal-header">
            <div>
                <h3 style="margin: 0;">üìÑ Ficha T√©cnica del TDR</h3>
                <span style="font-size: 12px; opacity: 0.8;">{{ tdrSeleccionado.numero_tdr }}</span>
            </div>
            <button class="btn-close-x" (click)="cerrarModalVer()">√ó</button>
        </div>

        <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
            
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 25px;">
                <h4 style="margin-top: 0; color: #003366; font-size: 14px; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 15px;">
                    üìå Informaci√≥n del Proceso
                </h4>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <div style="grid-column: span 2;">
                        <label class="modal-label">OBJETO DE CONTRATACI√ìN</label>
                        <p class="modal-value">{{ tdrSeleccionado.objeto_contratacion }}</p>
                    </div>
                    <div>
                        <label class="modal-label">PRESUPUESTO</label>
                        <p class="modal-value" style="color: #28a745;">${{ (tdrSeleccionado.presupuesto_referencial || 0) | number:'1.2-2' }}</p>
                    </div>
                    <div>
                        <label class="modal-label">DIRECCI√ìN</label>
                        <p class="modal-value">{{ tdrSeleccionado.direccion_solicitante || tdrSeleccionado.nombre_direccion || 'No especificada' }}</p>
                    </div>
                    <div>
                        <label class="modal-label">ESTADO</label>
                        <span class="badge" [ngClass]="getClaseBadge(tdrSeleccionado.estado)" style="margin-top: 5px; display: inline-block;">
                            {{ getTextoEstado(tdrSeleccionado.estado) }}
                        </span>
                    </div>
                </div>
            </div>

            <h4 style="margin-top: 0; color: #003366; font-size: 14px; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 15px;">
                üìÅ Expediente Digital
            </h4>

            <div class="cards-grid">
                
                <div class="doc-card" [class.active]="tdrSeleccionado.nombre_archivo_necesidad">
                    <p class="card-title">Informe Necesidad</p>

                    <div *ngIf="tdrSeleccionado.nombre_archivo_necesidad">
                        <i class="fas fa-file-pdf text-danger" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <span class="file-name">{{ tdrSeleccionado.nombre_archivo_necesidad }}</span>
                        
                        <div style="margin-top: 10px; display: flex; gap: 5px; justify-content: center;">
                            <button (click)="descargarArchivo(tdrSeleccionado.ruta_necesidad)" class="btn-ver" title="Ver PDF">üëÅÔ∏è</button>
                            <button *ngIf="esAdmin" (click)="eliminarArchivo(tdrSeleccionado.id_archivo_necesidad)" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </div>

                    <div *ngIf="!tdrSeleccionado.nombre_archivo_necesidad">
                        <i class="fas fa-cloud-upload-alt card-icon"></i>
                        <button class="btn-upload-action">‚¨ÜÔ∏è Subir PDF</button>
                        <input type="file" class="hidden-input" accept="application/pdf" (change)="onFileSelected($event, 'necesidad')">
                    </div>
                </div>

                <div class="doc-card" [class.active]="tdrSeleccionado.nombre_archivo_tdr">
                    <p class="card-title">Documento TDR</p>

                    <div *ngIf="tdrSeleccionado.nombre_archivo_tdr">
                        <i class="fas fa-file-contract text-primary" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <span class="file-name">{{ tdrSeleccionado.nombre_archivo_tdr }}</span>
                        
                        <div style="margin-top: 10px; display: flex; gap: 5px; justify-content: center;">
                            <button (click)="descargarArchivo(tdrSeleccionado.ruta_tdr)" class="btn-ver" title="Ver PDF">üëÅÔ∏è</button>
                            <button *ngIf="esAdmin" (click)="eliminarArchivo(tdrSeleccionado.id_archivo_tdr)" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </div>

                    <div *ngIf="!tdrSeleccionado.nombre_archivo_tdr">
                        <i class="fas fa-cloud-upload-alt card-icon"></i>
                        <button class="btn-upload-action">‚¨ÜÔ∏è Subir PDF</button>
                        <input type="file" class="hidden-input" accept="application/pdf" (change)="onFileSelected($event, 'tdr')">
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button (click)="imprimirFicha()" style="background: #003366; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                üñ®Ô∏è Imprimir Ficha
            </button>

            <button (click)="cerrarModalVer()" class="btn-cerrar">Cerrar</button>
        </div>
    </div>
</div>